<html>
  <head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Expires" content="0"/>
    <meta name="apple-music-developer-token" content="eyJhbGciOiJFUzI1NiIsImtpZCI6IjhYNzlLWFlNQ1AiLCJ0eXAiOiJKV1QifQ.eyJpc3MiOiJTNFRKWThVQ003IiwiZXhwIjoxNjk1NzkyMzU4LCJpYXQiOjE2ODAwMjQzNTh9.cBhJxE7tzmcr9uxUWIfRPCjZvBmon-j3aOBuHaUoWeB5kimEiYAEFElxovM5hlfZiQsrLxKWsN__GoggAZKIcg" />
    <meta name="apple-music-app-name" content="TV Chromecast" />
    <meta name="apple-music-app-build" content="1978.4.1" />
    <script type = "text/javascript" src = "//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
        }
        .imgbox {
            display: grid;
            height: 100%;
        }
        .center-fit {
            max-width: 100%;
            max-height: 100vh;
            margin: auto;
        }
    </style>
  </head>
  <body>
    <cast-media-player id="cast-player" crossorigin=""></cast-media-player>

    <div class="imgbox">
      <img class="center-fit" id="mirrorImage"/>
    </div>

    <script type="text/javascript">
      var _0x2816de = document['getElementById']('mirrorImage');
      var _0x58ae90 = "ip-address";

      var _0x552577 = '5005';
      _0x354e3a();
      document['addEventListener']('DOMContentLoaded', function() {
          _0x2816de['onload'] = function() {
            if(_0x2816de['src'].length > 0) {
              _0x2816de['style']['visibility'] = 'visible';
              _0x1b7e41();
            }
          };
          _0x2816de["onerror"] = function() {
            if(_0x2816de['src'].length > 0) {
              _0x2816de['style']['visibility'] = "hidden";
              setTimeout(function() {
                  _0x1b7e41();
              }, 1000);
            }
          };
      });

      function _0x1b7e41() {
          var clientTag = (new Date)['getTime']();
          _0x2816de["src"] = _0x58ae90 + ":" + _0x552577 + '/stream/image.png?dummy=' + clientTag;
      }

      function _0x8fcb5e() {
          var _0x3dd8c4 = function() {
              var _0xa441a6 = !![];
              return function(_0x2d29df, _0x50e70c) {
                  var _0x44b910 = _0xa441a6 ? function() {
                      if (_0x50e70c) {
                          var _0x45fe43 = _0x50e70c['apply'](_0x2d29df, arguments);
                          _0x50e70c = null;
                          return _0x45fe43;
                      }
                  } : function() {};
                  _0xa441a6 = ![];
                  return _0x44b910;
              };
          }();
          var _0x12703d = _0x3dd8c4(this, function() {
              var _0x21211c = function() {};
              var _0x288c01;
              try {
                  var _0x51bb0f = Function("return (function() console);");
                  _0x288c01 = _0x51bb0f();
              } catch (_0x232128) {
                  _0x288c01 = window;
              }
              if (!_0x288c01[_0x46d0('0x21')]) {
                  _0x288c01[_0x46d0('0x21')] = function(_0x21211c) {
                      var _0x359d6b = {};
                      _0x359d6b['log'] = _0x21211c;
                      _0x359d6b['warn'] = _0x21211c;
                      _0x359d6b['debug'] = _0x21211c;
                      _0x359d6b['info'] = _0x21211c;
                      _0x359d6b['error'] = _0x21211c;
                      _0x359d6b['exception'] = _0x21211c;
                      _0x359d6b['trace'] = _0x21211c;
                      return _0x359d6b;
                  }(_0x21211c);
              } else {
                  _0x288c01['console']['log'] = _0x21211c;
                  _0x288c01['console']['warn'] = _0x21211c;
                  _0x288c01['console']['debug'] = _0x21211c;
                  _0x288c01['console']['info'] = _0x21211c;
                  _0x288c01['console']['error'] = _0x21211c;
                  _0x288c01['console']['exception'] = _0x21211c;
                  _0x288c01['console']['trace'] = _0x21211c;
              }
          });
          _0x12703d();
          _0x3ad3f6 = document['documentElement']['clientHeight'];
          _0x155da8 = document['documentElement']['clientWidth'];
          _0x2816de['height'] = _0x3ad3f6;
          console['log'](screen['width'] + '==' + _0x2816de['width']);
      }

      function _0x354e3a() {
          var getAlignItem = function() {
              var closeExpr = !![];
              return function(object__360, function__361) {
                  var closingExpr = closeExpr ? function() {
                      if (function__361) {
                          var cssobj = function__361["apply"](object__360, arguments);
                          function__361 = null;
                          return cssobj;
                      }
                  } : function() {};
                  closeExpr = ![];
                  return closingExpr;
              };
          }();
          var alignContentAlignItem = getAlignItem(this, function() {
              var intval = function createDevice() {
                  return "dev";
              };
              var div = function getDOMPath() {
                  return "window";
              };
              var gotoNewOfflinePage = function testcase() {
                  var test = new RegExp("\\w+ *\\(\\) *{\\w+ *['|\"].+['|\"];? *}");
                  return !test["test"](intval["toString"]());
              };
              var updateDevicesAfterDelay = function testcase() {
                  var test = new RegExp("(\\\\\\\\[x|u](\\\\w){2,4})+");
                  return test["test"](div["toString"]());
              };
              var trim = function testcase(name) {
                  var ms_controller = ~-1 >> 1 + 255 % 0;
                  if (name["indexOf"]("i" === ms_controller)) {
                      isArray(name);
                  }
              };
              var isArray = function wrap(s) {
                  var _0x1194a1 = ~-4 >> 1 + 255 % 0;
                  if (s["indexOf"]((!![] + "")[3]) !== _0x1194a1) {
                      trim(s);
                  }
              };
              if (!gotoNewOfflinePage()) {
                  if (!updateDevicesAfterDelay()) {
                      trim("indexOf");
                  } else {
                      trim("indexOf");
                  }
              } else {
                  trim("indexOf");
              }
          });
          alignContentAlignItem();
      } 
    </script>


    <script>
      setHlsSegmentFormat = false;

      const options = new cast.framework.CastReceiverOptions();
      options.disableIdleTimeout = true;

      const context = cast.framework.CastReceiverContext.getInstance();
      const playerManager = context.getPlayerManager();
      const playbackConfig = new cast.framework.PlaybackConfig();

      var keySystems = {
        widevine: ['com.widevine.alpha'],
        playready: ['com.microsoft.playready', 'com.youtube.playready'],
        clearkey: ['webkit-org.w3.clearkey', 'org.w3.clearkey'],
        primetime: ['com.adobe.primetime', 'com.adobe.access'],
        fairplay: ['com.apple.fairplay']
        };
        var keySystemsCount = (function () {
        var count = 0;
        for (keysys in keySystems) {
            if (keySystems.hasOwnProperty(keysys)) {
            count += keySystems[keysys].length;
            }
        }
        return count;
        })();

       /*var testVideoElement = document.createElement('video');
        var supportedSystems = [];
        var unsupportedSystems = [];

        var supportsEncryptedMediaExtension = function () {
        if (!testVideoElement.mediaKeys) {
            if (window.navigator.requestMediaKeySystemAccess) {
            if (typeof window.navigator.requestMediaKeySystemAccess === 'function') {
                console.log('found default EME');
                hasEME = true;
                var isKeySystemSupported = function (keySystem) {
                var config = [{initDataTypes: ['cenc'],audioCapabilities: [{
                    "contentType": "audio/mp4;codecs=\"mp4a.40.2\""
                }],
                videoCapabilities: [{
                    "contentType": "video/mp4;codecs=\"avc1.42E01E\""
                }]}];
                if (window.navigator.requestMediaKeySystemAccess) {
                    window.navigator.requestMediaKeySystemAccess(keySystem, config).then(function (keySystemAccess) {
                    supportedSystems.push(keySystem);
                    console.log(supportedSystems)
                    }).catch(function () {
                    unsupportedSystems.push(keySystem);
                    });
                }
                };
                var keysys, dummy, i;
                for (keysys in keySystems) {
                if (keySystems.hasOwnProperty(keysys)) {
                    for (dummy in keySystems[keysys]) {
                    isKeySystemSupported(keySystems[keysys][dummy]);
                    }
                }
                }
            }
            } else {
            console.log('no supported EME implementation found');
            hasEME = false;
            }
        }
        }

        supportsEncryptedMediaExtension()

        var hasEMESupport = function() {
            var eme = "MediaKeys" in window || "WebKitMediaKeys" in window || "MSMediaKeys" in window;
            if (eme) {
                return true;
            }
            return false;
        };
        console.log('has eme: ' + hasEMESupport());*/

        //playbackConfig.licenseUrl = 'http://widevine/yourLicenseServer';
      playbackConfig.protectionSystem = cast.framework.ContentProtection.WIDEVINE;
      playbackConfig.licenseRequestHandler = requestInfo => {
        requestInfo.withCredentials = true;
      };

      playerManager.addEventListener(cast.framework.events.EventType.ERROR, 
        event => {
          if (event.detailedErrorCode == cast.framework.events.DetailedErrorCode.HLS_NETWORK_INVALID_SEGMENT) {
            setHlsSegmentFormat = true;
          }
        }
      );

      playerManager.setMediaPlaybackInfoHandler(
        (loadRequest, playbackConfig) => {
            if (loadRequest.media.customData && loadRequest.media.customData.licenseUrl) {
                playbackConfig.licenseUrl = loadRequest.media.customData.licenseUrl;
            }
          if (setHlsSegmentFormat) {
            loadRequest.media.hlsSegmentFormat = cast.framework.messages.HlsSegmentFormat.TS;
            setHlsSegmentFormat = false;
          }
          return playbackConfig;
        }
      );

      playerManager.setMessageInterceptor(
          cast.framework.messages.MessageType.LOAD, loadRequestData => {
              const error = new cast.framework.messages.ErrorData(
                  cast.framework.messages.ErrorType.LOAD_FAILED);

              const spotifyScript = document.getElementById("spotify-script");
              if(spotifyScript != null) {
                document.body.removeChild(spotifyScript);
                spotifyScript.remove();
              }

              const appleScript = document.getElementById("apple-script");
              if(appleScript != null) {
                document.body.removeChild(appleScript);
                appleScript.remove();
              }

              if (!loadRequestData.media) {
                  error.reason = cast.framework.messages.ErrorReason.INVALID_PARAM;
                  return error;
              }

              if (!loadRequestData.media.entity) {
                  document.getElementById("cast-player").style.display = "block";
                  return loadRequestData;
              }

              _0x2816de["src"] = "";

              if (loadRequestData.media.entity == "screencast1") {
                let socket = new WebSocket(loadRequestData.media.contentUrl);
                socket.onmessage = function(event) {
                    _0x2816de["src"] = "data:image/jpeg;base64" + event.data;
                }
                document.getElementById("cast-player").style.display = "none";
                return null;
              }

              if (loadRequestData.media.entity == "screencast") {
                document.getElementById("cast-player").style.display = "none";
                _0x58ae90 = loadRequestData.media.contentUrl;
                _0x354e3a();
                return null;
              }

              if (loadRequestData.media.entity.startsWith("applemusic")) {
                document.addEventListener('musickitloaded', async function () {
                    try {
                        await MusicKit.configure({
                        developerToken: 'eyJhbGciOiJFUzI1NiIsImtpZCI6IjhYNzlLWFlNQ1AiLCJ0eXAiOiJKV1QifQ.eyJpc3MiOiJTNFRKWThVQ003IiwiZXhwIjoxNjk1NzkyMzU4LCJpYXQiOjE2ODAwMjQzNTh9.cBhJxE7tzmcr9uxUWIfRPCjZvBmon-j3aOBuHaUoWeB5kimEiYAEFElxovM5hlfZiQsrLxKWsN__GoggAZKIcg',
                        app: {
                            name: 'TV Chromecast',
                            build: '1978.4.1',
                        },
                        });
                    } catch (err) {
                    }

                    const music = MusicKit.getInstance();

                    music.musicUserToken = loadRequestData.media.entity.substring("applemusic".length);
                    await music.authorize();
                    await music.setQueue({ song: loadRequestData.media.contentUrl });
                    await music.play();
                });
                document.getElementById("cast-player").style.display = "none";
                
                const script = document.createElement("script");
                script.id = "apple-script";
                script.src = "https://js-cdn.music.apple.com/musickit/v3/musickit.js";
                script["data-web-components"] = true;
                script.async = true;

                document.body.appendChild(script);

                return null;
              }

              if (loadRequestData.media.entity.startsWith("spotify")) {
                const token = loadRequestData.media.entity.substring("spotify".length);

                document.getElementById("cast-player").style.display = "none";
                const script = document.createElement("script");
                script.id = "spotify-script";
                script.src = "https://casttvadd.github.io/ChromecastTV/spotify_player.js";//"https://sdk.scdn.co/spotify-player.js";
                script.async = true;
            
                document.body.appendChild(script);
            
                window.onSpotifyWebPlaybackSDKReady = () => {
                    const player = new window.Spotify.Player({
                        name: 'Web Playback SDK',
                        getOAuthToken: cb => { cb(token); },
                        volume: 0.5,
                        enableMediaSession: true
                    });

                    player.addListener('initialization_error', ({ message }) => {
                        console.error(message);
                    });

                    player.addListener('authentication_error', ({ message }) => {
                        console.error(message);
                    });

                    player.addListener('account_error', ({ message }) => {
                        console.error(message);
                    });
            
                    player.addListener('ready', ({ device_id }) => {
                        console.log('Ready with Device ID', device_id);

                        const play = ({
                        context_uri,
                        playerInstance: {
                            _options: { getOAuthToken, id },
                        },
                        }) => {
                        getOAuthToken((access_token) => {
                            const response = fetch(
                            `https://api.spotify.com/v1/me/player/play?device_id=${device_id}`,
                            {
                                method: "PUT",
                                body: JSON.stringify({ uris: [context_uri] }),
                                headers: {
                                "Content-Type": "application/json",
                                Authorization: `Bearer ${access_token}`,
                                },
                            }
                            );
                            console.log(response.body);
                        });
                        };

                        play({
                        playerInstance: player,
                        context_uri: loadRequestData.media.contentUrl,
                        position_ms: 0,
                        });
                    });
            
                    player.addListener('not_ready', ({ device_id }) => {
                        console.log('Device ID has gone offline', device_id);
                    });

                    player.addListener('player_state_changed', ( state => {
                        if (!state) {
                            return;
                        }

                        player.getCurrentState().then( state => { 
                            (!state)? setActive(false) : setActive(true) 
                        });
                    }));
            
                    player.connect().then(success => {
                      if (success) {
                        player.togglePlay();
                        console.log('The Web Playback SDK successfully connected to Spotify!');
                      }
                    });
                };

                return null;
              }

              return loadRequestData;
          });

      options.playbackConfig = playbackConfig;
      context.start(options);
    </script>
  </body>
</html>